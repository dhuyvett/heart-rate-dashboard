name: Build Flutter App

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
  release:
    types: [created]
  workflow_dispatch:

permissions:
  actions: write
  checks: write
  contents: write

jobs:
  analyze-and-test:
    name: Analyze Code & Run Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install test dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y lld libsqlite3-dev

      - name: Set up Flutter
        uses: subosito/flutter-action@fd55f4c5af5b953cc57a2be44cb082c8f6635e8e # v2.21.0
        with:
          channel: stable
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Run analyzer
        run: flutter analyze

      - name: Run tests
        run: flutter test --coverage --branch-coverage

      - name: Generate coverage summary
        if: always()
        uses: ./.github/actions/generate-coverage-summary

      - name: Set coverage annotation
        if: always()
        uses: ./.github/actions/set-coverage-annotation

  build-debug-apk-pr:
    name: Build Debug APK (PR)
    runs-on: ubuntu-latest
    needs: analyze-and-test
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Set up Java
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5.2.0
        with:
          distribution: temurin
          java-version: '17'

      - name: Set up Flutter
        uses: subosito/flutter-action@fd55f4c5af5b953cc57a2be44cb082c8f6635e8e # v2.21.0
        with:
          channel: stable
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Build debug APK
        run: flutter build apk --debug

      - name: Upload debug APK artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: app-debug-pr-${{ github.event.pull_request.number }}.apk
          path: build/app/outputs/flutter-apk/app-debug.apk
          retention-days: 30

  build-and-attach-release:
    name: Build Release APK/AAB + Attach to Release
    runs-on: ubuntu-latest
    needs: analyze-and-test
    if: github.event_name == 'release'
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Set up Java
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5.2.0
        with:
          distribution: temurin
          java-version: '17'

      - name: Set up Flutter
        uses: subosito/flutter-action@fd55f4c5af5b953cc57a2be44cb082c8f6635e8e # v2.21.0
        with:
          channel: stable
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Derive build version from release tag
        run: |
          TAG_NAME="${{ github.event.release.tag_name }}"
          BUILD_NAME="${TAG_NAME#v}"

          if [ -z "$BUILD_NAME" ] || [ "$BUILD_NAME" = "$TAG_NAME" ]; then
            echo "Release tag must start with 'v' (example: v1.2.3)."
            exit 1
          fi

          if ! echo "$BUILD_NAME" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "Release tag version is invalid: $BUILD_NAME"
            echo "Expected exact tag format: v<major>.<minor>.<patch> (example: v1.2.3)"
            exit 1
          fi

          echo "BUILD_NAME=$BUILD_NAME" >> "$GITHUB_ENV"
          echo "BUILD_NUMBER=${{ github.run_number }}" >> "$GITHUB_ENV"

      - name: Create Android signing files
        run: |
          echo "${{ secrets.ANDROID_UPLOAD_KEYSTORE_BASE64 }}" | base64 --decode > android/upload-keystore.jks
          cat > android/key.properties <<EOF
          storePassword=${{ secrets.ANDROID_UPLOAD_STORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_UPLOAD_KEY_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_UPLOAD_KEY_ALIAS }}
          storeFile=../upload-keystore.jks
          EOF

      - name: Build release APK
        run: |
          flutter build apk --release \
            --build-name="$BUILD_NAME" \
            --build-number="$BUILD_NUMBER"

      - name: Build release App Bundle
        run: |
          flutter build appbundle --release \
            --build-name="$BUILD_NAME" \
            --build-number="$BUILD_NUMBER"

      - name: Attach release APK and App Bundle to GitHub release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          files: |
            build/app/outputs/flutter-apk/app-release.apk
            build/app/outputs/bundle/release/app-release.aab

  builds-succeeded:
    name: Builds Succeeded
    runs-on: ubuntu-latest
    needs: [build-debug-apk-pr, build-and-attach-release]
    if: always()
    env:
      DEBUG_RESULT: ${{ needs.build-debug-apk-pr.result }}
      RELEASE_RESULT: ${{ needs.build-and-attach-release.result }}
    steps:
      - name: Validate required builds
        run: |
          if [ "$DEBUG_RESULT" != "success" ] && [ "$DEBUG_RESULT" != "skipped" ]; then
            echo "build-debug-apk-pr result: $DEBUG_RESULT"
            exit 1
          fi

          if [ "$RELEASE_RESULT" != "success" ] && [ "$RELEASE_RESULT" != "skipped" ]; then
            echo "build-and-attach-release result: $RELEASE_RESULT"
            exit 1
          fi

          echo "All required build jobs completed successfully."
