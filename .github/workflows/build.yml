name: Build Flutter App

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

permissions:
  actions: write
  contents: read

jobs:
  analyze-and-test:
    name: Analyze Code & Run Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install test dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y lld libsqlite3-dev

      - name: Set up Flutter
        uses: subosito/flutter-action@fd55f4c5af5b953cc57a2be44cb082c8f6635e8e # v2.21.0
        with:
          channel: stable
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Run analyzer
        run: flutter analyze

      - name: Run tests
        run: flutter test --coverage --branch-coverage

      - name: Generate coverage summary
        if: always()
        uses: ./.github/actions/generate-coverage-summary

      - name: Set coverage annotation
        if: always()
        uses: ./.github/actions/set-coverage-annotation

  build-debug-apk-pr:
    name: Build Debug APK (PR)
    runs-on: ubuntu-latest
    needs: analyze-and-test
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Set up Java
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5.2.0
        with:
          distribution: temurin
          java-version: '17'

      - name: Set up Flutter
        uses: subosito/flutter-action@fd55f4c5af5b953cc57a2be44cb082c8f6635e8e # v2.21.0
        with:
          channel: stable
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Build debug APK
        run: flutter build apk --debug

      - name: Upload debug APK artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: app-debug-pr-${{ github.event.pull_request.number }}.apk
          path: build/app/outputs/flutter-apk/app-debug.apk
          retention-days: 30

  builds-succeeded:
    name: Builds Succeeded
    runs-on: ubuntu-latest
    needs: [analyze-and-test, build-debug-apk-pr]
    if: always()
    env:
      ANALYZE_RESULT: ${{ needs.analyze-and-test.result }}
      DEBUG_RESULT: ${{ needs.build-debug-apk-pr.result }}
    steps:
      - name: Validate required builds
        run: |
          if [ "$ANALYZE_RESULT" != "success" ]; then
            echo "analyze-and-test result: $ANALYZE_RESULT"
            exit 1
          fi

          if [ "$DEBUG_RESULT" != "success" ] && [ "$DEBUG_RESULT" != "skipped" ]; then
            echo "build-debug-apk-pr result: $DEBUG_RESULT"
            exit 1
          fi

          echo "All required build jobs completed successfully."
