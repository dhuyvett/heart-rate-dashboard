name: Build Flutter App

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write
  id-token: write

jobs:
  analyze-and-test:
    name: Analyze Code & Run Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install test dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y lld libsqlite3-dev

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Run analyzer
        run: flutter analyze

      - name: Run tests
        run: flutter test --coverage --branch-coverage

  build-debug-apk-pr:
    name: Build Debug APK (PR)
    runs-on: ubuntu-latest
    needs: analyze-and-test
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v6

      - name: Set up Java
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: '17'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Build debug APK
        run: flutter build apk --debug

      - name: Upload debug APK artifact
        uses: actions/upload-artifact@v6
        with:
          name: app-debug-pr-${{ github.event.pull_request.number }}.apk
          path: build/app/outputs/flutter-apk/app-debug.apk
          retention-days: 30

  build-and-publish-release:
    name: Build Release APK + Publish to Play
    runs-on: ubuntu-latest
    needs: analyze-and-test
    if: github.event_name == 'release'
    env:
      PLAY_TRACK: ${{ vars.PLAY_TRACK || 'internal' }}
    steps:
      - uses: actions/checkout@v6

      - name: Set up Java
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: '17'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Create Android signing files
        run: |
          echo "${{ secrets.ANDROID_UPLOAD_KEYSTORE_BASE64 }}" | base64 --decode > android/upload-keystore.jks
          cat > android/key.properties <<EOF
          storePassword=${{ secrets.ANDROID_UPLOAD_STORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_UPLOAD_KEY_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_UPLOAD_KEY_ALIAS }}
          storeFile=../upload-keystore.jks
          EOF

      - name: Build release APK
        run: flutter build apk --release

      - name: Build release App Bundle
        run: flutter build appbundle --release

      - name: Attach release APK to GitHub release
        uses: softprops/action-gh-release@v2
        with:
          files: build/app/outputs/flutter-apk/app-release.apk

      - name: Authenticate to Google Cloud (WIF)
        id: auth
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_PLAY_SA_EMAIL }}

      - name: Upload App Bundle to Google Play
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJson: ${{ steps.auth.outputs.credentials_file_path }}
          packageName: org.dhuyvetter.heart_rate_dashboard
          releaseFiles: build/app/outputs/bundle/release/app-release.aab
          track: ${{ env.PLAY_TRACK }}
          status: completed
